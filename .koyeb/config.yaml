# Koyeb Configuration for APIIngest
# This file defines the deployment configuration for both backend and frontend services

services:
  # Backend Service (FastAPI)
  - name: apiingest-backend
    type: web
    instance_type: micro
    ports:
      - port: 8000
        protocol: http
    routes:
      - path: /
        port: 8000
    build:
      type: buildpack
      working_directory: backend
    run_command: sh -c "uvicorn main:app --host 0.0.0.0 --port 8000 --workers ${WEB_CONCURRENCY:-1}"
    env:
      - name: PORT
        value: "8000"
      - name: ALLOWED_ORIGINS
        # Update this after frontend deployment
        value: "https://your-frontend-url.koyeb.app"
      - name: WEB_CONCURRENCY
        value: "1"
      - name: MAX_UPLOAD_BYTES
        value: "10485760"
    health_check:
      http:
        path: /health
        port: 8000
      grace_period: 30
      interval: 30
      timeout: 10
      restart_limit: 3

  # Frontend Service (Next.js)
  - name: apiingest-frontend
    type: web
    instance_type: micro
    ports:
      - port: 3000
        protocol: http
    routes:
      - path: /
        port: 3000
    build:
      type: buildpack
      working_directory: frontend
      build_command: npm install && npm run build
    run_command: npm start
    env:
      - name: NODE_ENV
        value: production
      - name: NEXT_PUBLIC_API_URL
        # Update this with backend URL after deployment
        value: "https://your-backend-url.koyeb.app"

# Regions (choose closest to your users)
# Available: fra (Frankfurt), was (Washington), sin (Singapore)
regions:
  - fra

# Auto-scaling configuration (optional)
autoscaling:
  min_instances: 1
  max_instances: 1

